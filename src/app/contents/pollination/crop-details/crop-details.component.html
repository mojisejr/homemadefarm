<div *ngIf="cropDetails | async; else loading; let crop" fxLayout="column" class="container">
    <div fxFlexOffset="1rem" fxLayoutAlign="space-between" class="header">
        <div class="header-details">
            <h1>Room: {{ crop.room }}</h1>
            <h3>Crop: {{ crop.crop }}</h3>
        </div>
        <div class="header-menu" fxLayoutGap="0.5rem">
            <button routerLink="/admin" mat-fab><mat-icon>arrow_back</mat-icon></button>
        </div>
    </div>
    <div>
        <mat-tab-group>
            <mat-tab label="Main">
                <div class="content-wrapper">
                    <div ngStyle.xs="width: 90%;" fxLayout="column" fxLayoutGap="1rem" fxLayoutAlign="center" class="dashboard">
                        <div fxLayout.xs="column" ngStyle.xs="width: 100%;" fxLayout="row wrap" fxLayoutGap="1rem" class="row-content-1">
                            <div class="crop-details">
                                <mat-card>
                                    <mat-card-header>
                                        <mat-card-subtitle>Created At</mat-card-subtitle>
                                    </mat-card-header>
                                    <mat-card-content>
                                        <h3>{{ crop.createdAt }}</h3>
                                    </mat-card-content>
                                </mat-card>
                            </div>
                            <div class="totray">
                                <mat-card>
                                    <mat-card-header>
                                        <mat-card-subtitle>toTrayAt</mat-card-subtitle>
                                    </mat-card-header>
                                    <mat-card-content *ngIf="crop.toTrayAt != null; else trayUpdate;">
                                       <h3>{{ crop.toTrayAt }}</h3>
                                    </mat-card-content>
                                </mat-card>
                            </div>
                            <div *ngIf="crop.status != 'Initial'" class="tobag">
                                <mat-card>
                                    <mat-card-header>
                                        <mat-card-subtitle>toBagAt</mat-card-subtitle>
                                    </mat-card-header>
                                    <mat-card-content *ngIf="crop.toBagAt != null; else bagUpdate;">
                                        <h3>{{ crop.toBagAt }}</h3>
                                    </mat-card-content>
                                </mat-card>
                            </div>
                            <div *ngIf="crop.status === 'Closed'" class="crop-dayCount">
                                <mat-card>
                                    <mat-card-header>
                                        <mat-card-subtitle>fromStart</mat-card-subtitle>
                                    </mat-card-header>
                                    <mat-card-content>
                                        <h3>{{ crop.fromStartCount }} days</h3>
                                    </mat-card-content>
                                </mat-card>
                            </div>
                            <div *ngIf="crop.status === 'Closed'" class="crop-dayCount">
                                <mat-card>
                                    <mat-card-header>
                                        <mat-card-subtitle>fromTrayToBag</mat-card-subtitle>
                                    </mat-card-header>
                                    <mat-card-content>
                                        <h3>{{ crop.fromTrayToBag }} days</h3>
                                    </mat-card-content>
                                </mat-card>
                            </div>
                            <div class="crop-dayCount">
                                <mat-card>
                                    <mat-card-header>
                                        <mat-card-subtitle>fromToBag</mat-card-subtitle>
                                    </mat-card-header>
                                    <mat-card-content>
                                        <h3 *ngIf="crop.status != 'Closed'">{{ dayCount }} days</h3>
                                        <h3 *ngIf="crop.status === 'Closed'">{{ crop.fromToBagCount }} days [CLOSED]</h3>
                                    </mat-card-content>
                                </mat-card>
                            </div>
                        </div>
                        <mat-card>
                            <mat-card-header>
                                <mat-card-subtitle>Status</mat-card-subtitle>
                            </mat-card-header>
                            <mat-card-content fxLayoutAlign="center center">
                                <h3>{{ crop.status }}</h3>
                            </mat-card-content>
                        </mat-card>
                        <mat-card *ngIf="crop.status != 'Initial'  && crop.status != 'Closed'" class="tagTable">
                            <div class="tagTable-selector">

                                <mat-form-field>
                                    <mat-label>Type select:</mat-label>
                                    <mat-select (selectionChange) = "onTypeSnapshotChange($event, crop.status)">
                                        <mat-option *ngFor="let item of crop.species; let index = index" [value]="item.species"> {{ item.species }}</mat-option>
                                    </mat-select>
                                </mat-form-field>
                            </div>
                            <div *ngIf="all$ | async; let dataSource" class="tagTable-table">
                                <form *ngIf="crop.status != 'postPollination' && crop.status != 'Harvesting' && crop.status != 'Closed'" [formGroup]="tagCreateForm" (ngSubmit)="onTagCreate()">
                                    <mat-form-field >
                                        <input
                                        type="text"
                                        formControlName="tagColor"
                                        placeholder="TagColor"
                                        matInput>
                                    </mat-form-field>
                                    <button mat-button type="submit" color="primary">Create</button>
                                </form>
                                <mat-table *ngIf="dataSource.length > 0;" [dataSource]="dataSource">
                                    <ng-container matColumnDef="tagColor">
                                        <mat-header-cell *matHeaderCellDef>tagColor</mat-header-cell>
                                        <mat-cell *matCellDef="let element" [style.color]="element.tagColor">{{ element.tagColor }}</mat-cell>
                                    </ng-container>
                
                                    <ng-container matColumnDef="createdAt">
                                        <mat-header-cell *matHeaderCellDef>createdAt</mat-header-cell>
                                        <mat-cell *matCellDef="let element">{{ element.createdAt }}</mat-cell>
                                    </ng-container>
                
                                    <ng-container matColumnDef="currentDay">
                                        <mat-header-cell *matHeaderCellDef>currentDay</mat-header-cell>
                                        <mat-cell *matCellDef="let element">{{ element.currentDay }}</mat-cell>
                                    </ng-container>
                
                                    <ng-container matColumnDef="dayLeft">
                                        <mat-header-cell *matHeaderCellDef>dayLeft</mat-header-cell>
                                        <mat-cell *matCellDef="let element">{{ element.dayLeft }}</mat-cell>
                                    </ng-container>
                
                                    <ng-container matColumnDef="estHarvestDate">
                                        <mat-header-cell *matHeaderCellDef>estHarvestDate</mat-header-cell>
                                        <mat-cell *matCellDef="let element">{{ element.estHarvestDate }}</mat-cell>
                                    </ng-container>
                
                                    <ng-container matColumnDef="actions">
                                        <mat-header-cell *matHeaderCellDef><mat-icon>more_vert</mat-icon></mat-header-cell>
                                        <mat-cell *matCellDef="let element"><button (click)="onTagDelete(element.typeId)" mat-icon-button color="warn"><mat-icon>backspace</mat-icon></button></mat-cell>
                                    </ng-container>
                
                                    <mat-header-row *matHeaderRowDef="displayedColumns"></mat-header-row>
                                    <mat-row *matRowDef="let row; columns: displayedColumns;"></mat-row>
                                </mat-table>
                                
                                <div *ngIf="dataSource.length === 0">no data please create one.</div>
                                <div class="pollinationFinish" *ngIf="dataSource.length > 0 && crop.status != 'postPollination' && crop.status !== 'Harvesting'">
                                    <button (click)="onFinish()"  mat-raised-button color="warn">Finish ?</button>
                                </div>
                            </div>
                        </mat-card>
                        <app-product class="product-sorting-box" *ngIf="crop.status === 'postPollination' || crop.status === 'Harvesting' || crop.status === 'Closed'" [crop]="crop" [cropId]="docId"></app-product>
                        <div *ngIf="crop.status === 'Harvesting'" fxLayoutAlign="end" class="closing-container">
                            <button mat-raised-button color="warn" (click)="onCropClose(crop)">Close Corp ?</button>
                        </div>
                    </div>
                </div>
            </mat-tab>
            <mat-tab label="Activities">
                <div class="content-wrapper">
                    <app-single-activities [crop]="crop" [docId]=[docId]></app-single-activities>
                </div>
            </mat-tab>
        </mat-tab-group>
    </div>
</div>




<ng-template #loading>
    <div class="spinner" fxLayoutAlign="center center">
        <mat-spinner></mat-spinner>
    </div>
</ng-template>

<ng-template #trayUpdate>
    <form [formGroup]="toTrayForm" (ngSubmit)="onUpdate()">
        <mat-form-field>
            <input 
            type="date"
            formControlName="toTrayAt" 
            matInput>
        </mat-form-field>
        <button mat-button type="submit" color="primary">Add</button>
    </form>
</ng-template>

<ng-template #bagUpdate>
    <form [formGroup]="toBagForm" (ngSubmit)="onUpdate()">
        <mat-form-field>
            <input 
            type="date" 
            formControlName="toBagAt"
            matInput>
        </mat-form-field>
        <button mat-button type="submit" color="primary">Add</button>
    </form>
</ng-template>